FROM fedora:41

# Set default environment variables
ENV TZ="America/Sao_Paulo"
ENV PYTHONUNBUFFERED=1
ENV RUN_ON_START="true"
ENV BOT_DIR_NAME="deepseek-v2"
ARG EDGE_VERSION="144.0.3719.92-1"
ARG EDGE_LINK="https://packages.microsoft.com/yumrepos/edge/Packages/m/microsoft-edge-stable-${EDGE_VERSION}.x86_64.rpm"

ENV HOME=/home/user

RUN dnf update -y && dnf install -y \
    tar \
    wget \
    jq \
    gnupg2 \
    curl \
    git \
    unzip \
    squid \
    bind-utils \
    nmap-ncat \
    tzdata \
    glibc-langpack-pt \
    procps-ng \
    libffi-devel \
    zlib-devel \
    xz-devel \
    bzip2-devel \
    readline-devel \
    sqlite-devel \
    nss \
    mesa-libgbm-devel \
    python3 \
    python3-pip \
    python3-flask \
    dos2unix \
    ca-certificates \
    glib2 \
    dbus-libs \
    expat \
    fontconfig \
    gtk3 \
    nspr \
    alsa-lib \
    atk \
    at-spi2-core \
    libdrm \
    mesa-libgbm \
    libX11 \
    libX11-xcb \
    libXcomposite \
    libXcursor \
    libXdamage \
    libXext \
    libXfixes \
    libXi \
    libXrandr \
    libXrender \
    libXScrnSaver \
    libXtst \
    && dnf clean all

RUN curl -fsSL https://rpm.nodesource.com/setup_22.x | bash - \
    && dnf install -y nodejs

RUN update-ca-trust

RUN wget -q -O /tmp/edge.rpm ${EDGE_LINK} && \
	dnf install -y /tmp/edge.rpm && \
	rm /tmp/edge.rpm && \
	microsoft-edge --version

# Set environment variables
ENV PATH="/home/user/.local/bin:/home/user/app/venv/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:${PATH}"

ENV PLAYWRIGHT_BROWSERS_PATH=$HOME/app/browsers
ENV CHROME_BIN=/usr/bin/google-chrome
ENV CHROME_PATH=/usr/lib/google-chrome/
ENV EDGE_BIN=/usr/bin/microsoft-edge
ENV EDGE_ENABLED=true

# Create user if it doesn't exist, or use existing one
RUN useradd -m -u 1000 user

WORKDIR $HOME/app

# Download and extract project files using REPO_URL environment variable
RUN mkdir -p $HOME/app/$BOT_DIR_NAME && cd $HOME/app/$BOT_DIR_NAME && \
    wget https://github.com/google-colabtools/${BOT_DIR_NAME}/archive/main.zip -O repo.zip \
	&& unzip repo.zip \
	&& mv $(unzip -Z1 repo.zip | head -n1 | cut -d/ -f1)/* . \
	&& rm -rf $(unzip -Z1 repo.zip | head -n1 | cut -d/ -f1) repo.zip \
    && mv entrypoint.sh runner_daily.sh keep_running.py runner.py rwds_functions.py requirements.txt starter.sh asgi.py $HOME/app/

WORKDIR $HOME/app/$BOT_DIR_NAME
# Install all dependencies required to build the script
RUN npm ci --ignore-scripts

# Install Chromium Headless Shell and Firefox without deps (we already installed them), and cleanup
RUN npx playwright install --only-shell chromium firefox && \
    rm -rf /root/.cache /tmp/* /var/tmp/*
# Build the project
RUN npm i baseline-browser-mapping@latest -D && \
    npm run build

WORKDIR $HOME/app

RUN mv $HOME/app/$BOT_DIR_NAME $HOME/app/${BOT_DIR_NAME}_A && \
    cp -r $HOME/app/${BOT_DIR_NAME}_A $HOME/app/${BOT_DIR_NAME}_B && \
    cp -r $HOME/app/${BOT_DIR_NAME}_A $HOME/app/${BOT_DIR_NAME}_C && \
    cp -r $HOME/app/${BOT_DIR_NAME}_A $HOME/app/${BOT_DIR_NAME}_D && \
    cp -r $HOME/app/${BOT_DIR_NAME}_A $HOME/app/${BOT_DIR_NAME}_E

RUN echo "âš™ï¸ Instalando ricronus em \$HOME/.local/bin..." && \
    mkdir -p $HOME/.local/bin && \
    wget -q https://drive.kingvegeta.workers.dev/1:/Files/colab-tools/tools/gclone -O $HOME/.local/bin/ricronus && \
    chmod +x $HOME/.local/bin/ricronus && \
    echo "âœ… ricronus instalado em $HOME/.local/bin/ricronus." && \
    echo "export PATH=\"$HOME/.local/bin:\$PATH\"" >> $HOME/.profile && \
    echo "ðŸ”§ Adicionando $HOME/.local/bin ao PATH..." && \
    $HOME/.local/bin/ricronus --help >/dev/null 2>&1 && \
    echo "ðŸ‘ ricronus estÃ¡ funcionando." || \
    (echo "âŒ Falha ao baixar ou executar ricronus." && exit 1)

RUN echo "âš™ï¸ Instalando socks-to-http-proxy em \$HOME/.local/bin..." && \
    wget -q https://github.com/KaranGauswami/socks-to-http-proxy/releases/download/v0.5.0/sthp-linux -O $HOME/.local/bin/sthp && \
    chmod +x $HOME/.local/bin/sthp && \
    echo "âœ… socks-to-http-proxy instalado em $HOME/.local/bin/sthp." && \
    (echo "âš ï¸ VerificaÃ§Ã£o do sthp ignorada - serÃ¡ testado em runtime." || true)

COPY --chown=user:user . /home/user/app

RUN ln -fs /usr/share/zoneinfo/${TZ} /etc/localtime && \
    echo "${TZ}" > /etc/timezone



# Adicione a referÃªncia ao CA no cache_peer do squid.conf
RUN mv /etc/squid/squid.conf /etc/squid/squid.conf.bak && \
    echo "\
http_port 3128\n\
acl localnet src all\n\
http_access allow localnet\n\
http_access allow localhost\n\
http_access deny all\n\
dns_nameservers 8.8.8.8 1.1.1.1 9.9.9.9 8.8.4.4 1.0.0.1\n\
cache deny all\n\
access_log stdio:/var/log/squid/access.log\n\
pid_filename /home/user/squid.pid\n\
" > /etc/squid/squid.conf

RUN sed -i 's/^#\?cache_effective_user.*/cache_effective_user user/' /etc/squid/squid.conf && \
    sed -i 's/^#\?cache_effective_group.*/cache_effective_group user/' /etc/squid/squid.conf

RUN mkdir -p /home/user && chown -R user:user /home/user

# Cria diretÃ³rios de log e cache
RUN mkdir -p /var/log/squid /var/spool/squid && \
    chown -R user:user /var/log/squid /var/spool/squid && \
    chown -R user:user /etc/squid/

# Inicializa o cache do squid
RUN squid -Nz

# Exponha a porta do proxy
EXPOSE 3128

# Set up environment variables for Chrome headless
ENV HOME=/home/user \
    CHROME_USER_DATA_DIR=/home/user/.config/chrome \
    NO_AT_BRIDGE=1 \
    VIRTUAL_ENV=/home/user/.venv


# Set up directories with proper permissions
RUN mkdir -p /home/user/.config/chrome \
    && mkdir -p /home/user/.cache/chrome \
    && chmod -R 0755 /home/user \
    && chmod -R 0700 /home/user/.config/chrome \
    && chmod -R 0700 /home/user/.cache/chrome \
    && chown -R user:user /home/user

RUN chown -R user:user $HOME
# --- MODIFIED SECTION FOR VIRTUAL ENVIRONMENT ---
# Create a virtual environment
RUN python3 -m venv $HOME/app/venv

RUN $HOME/app/venv/bin/pip install  --no-cache-dir --upgrade -r $HOME/app/requirements.txt

RUN chown -R user:user $HOME
RUN usermod -aG wheel user
RUN echo "user ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

USER user

# Set up permissions
COPY --chown=user . $HOME/app
RUN chown -R user:user /home/user/app
RUN ls
RUN dos2unix entrypoint.sh
RUN dos2unix runner_daily.sh
RUN chmod +x entrypoint.sh
RUN chmod +x runner_daily.sh
RUN ls
# Set the entrypoint to our entrypoint.sh

ENTRYPOINT ["/home/user/app/entrypoint.sh"]

# Define the command to run your application with cron optionally
CMD ["sh", "-c", "nohup uvicorn asgi:asgi_app --host 0.0.0.0 --port 7860 --workers 4 --log-level warning & \
    bash runner_daily.sh > /home/user/app/runner.log 2>&1"]
